-- Used percentile 10th speed for highway as baseline
-- Metrics table with 2019 data, adjusted mean and median 
CREATE TABLE congestion.metrics_v4_2019_af_v2 AS

SELECT segment_id, time_bin, num_bins,
avg_tt, avg_tt_corr, med_tt,  med_tt_corr, baseline_tt, baseline_tt_corr, baseline_tt_med, baseline_tt_med_corr, pct95_tt,
avg_tt / baseline_tt AS tti,
avg_tt_corr / baseline_tt_corr AS tti_corr,
med_tt / baseline_tt_med AS tti_med,
med_tt_corr / baseline_tt_med_corr AS tti_med_corr,
(pct95_tt - avg_tt)/avg_tt AS bi,
(pct95_tt - avg_tt_corr)/avg_tt_corr AS bi_corr

FROM (
SELECT a.segment_id, 
a.datetime_bin::time AS time_bin, 
COUNT(datetime_bin) AS num_bins, 
b.seg_length, 
AVG(a.segment_tt_avg_hc) AS avg_tt,
AVG(a.segment_tt_avg_hc_corr) AS avg_tt_corr,
AVG(a.segment_tt_med_hc) AS med_tt,
AVG(a.segment_tt_med_hc_corr) AS med_tt_corr,	
PERCENTILE_CONT (0.95) WITHIN GROUP (ORDER BY a.segment_tt_avg_hc ASC) AS pct95_tt,
PERCENTILE_CONT (0.95) WITHIN GROUP (ORDER BY a.segment_tt_avg_hc_corr ASC) AS pct95_tt_corr,
case when segment_id in (12082,4287,11523,8623,10827,3272,11534,9575,8025,4200,9173,601,8340,12275,4718,3674,11861,2956,7492,8298,8062,4193,2306,4632,5316,5530,11109,10884,8111,606,11533,11686,5933,599,5876,10893,6552,5912,3714,151,6595,9174,8008,6535,2813,7201,5895,1680,6100,12128,2676,8109,2310,5894,8997,2672,11776,11565,10838,3270,2308,10024,12073,8140,6564,137,2702,8141,10882,4185,5816,5266,11531,4679,5817,2950,3715,8034,2109,4208,10826,9185,11638,136,3622,4192,5769,11867,4681,4201,6554,9075,11611,4650,2901,10822,9684,2899,5264,9172,11017,2699,5249,9952,8032,4628,4002,2900,4651,7239,4630,8009,8936,10383,3283,3600,3823,11525,11709,10784,149,12215,7241,3274,10097,5142,11204,8952,5804,10128,4198,5252,2785,3104,2704,2902,1335,2897,9014,6513,11514,3824,11540,135,10823,8236,4184,7214,11409,8971,2673,10119,5597,9113,4634,6593,8935,4659,7229,9844,8944,142,4306,9521,2304,160,9017,6130,5315,1333,11551,3465,9057,6782,7215,10530,4225,2949,6574,12262,914,7213,10001,4302,2698,10293,11591,3282,6575,6560,4658,3463,10120,4652,12100,11535,11578,9522,11508,4680,9386,11186,139,146,10905,8969,4227,12091,2705,143,6562,2108,8100,2816,3626,6102,10853,5308,5846,10817,11860,12074,4631,4709,10834,4304,11597,3470,3700,11584,7877,5527,8727,11630,10847,7772,2700,5844,2896,9883,145,8238,4199,5526,2955,8300,12112,11033,4194,2671,8995,4678,4224,4290,2910,4212,8922,9940,4226,11885,6576,10801,11811,11532,4310,9882,12133,3603,5146,6557,2703,7131,10836,8018,7292,595,10531,7491,6371,8342,10023,5313,11689,4657,6538,12247,12114,2787,5870,4308,1681,3598,140,5767,11491,9628,8933,11018,11055,10009,153,11593,10854,10000,6577,7242,8132,9951,12085,10010,10033,9884,6129,6149,7774,8301,2789,3269,2112,11625,2959,11713,9184,915,10393,12106,5532,1346,2953,3220,596,5156,10839,10877,10849,7228,7844,3224,7370,2701,3226,7731,6558,4301,10755,2101,3679,8570,5807,11034,3107,2815,2783,7291,10949,12090,2958,5596,10950,6784,4753,5309,6110,8454,10808,9683,4819,9081,3997,4330,11615,7202,6150,4182,8332,8006,152,4312,4720,6515,6114,3273,10663,3820,8624,5848,11603,12110,10988,8338,7876,12094,8968,8026,4647,5910,11562,11590,4311,2305,9058,4211,5768,7231,5934,96,10008,2814,2098,7650,8097,2104,11639,9918,7872,600,10874,2952,9142,12292,3106,5911,10821,2677,10842,10810,6596,6561,10381,11779,913,8974,11494,5180,5262,11755,8954,6099,8455,8004,10880,8061,5598,6556,6594,11149,6537,8970,8572,10116,3713,9734,6567,8339,8170,11521,10835,10892,1328,8101,9520,4635,603,3103,4653,11510,6111,7730,9982,3718,11592,8003,5600,7982,12015,6783,158,10879,2103,7773,8171,10833,3673,2914,12221,9060,5147,7178,9305,11332,1330,9920,12078,2102,3623,7489,2951,9447,3619,4648,5806,4213,2669,4636,11886,10794,5815,12072,6559,1332,11687,4821,7227,2706,8096,11614,3102,4303,6578,11526,9080,5254,11710,4289,10662,8098,7180,11504,2670,8562,11577,10907,5871,5818,2105,8573,4660,10837,3681,8978,9919,10865,8726,5805,5253,12093,5931,1684,2903,5932,7226,2908,3717,3225,10816,7874,4677,5144,3678,2954,11561,8341,5158,2675,10115,4643,2957,5157,11607,9845,12186,5178,10392,5528,3675,5845,8094,11416,5847,12129,7179,9016,4644,7230,7845,8996,2947,9074,5874,12294,7405,7490,5312,8021,3699,3284,10532,6368,11511,9939,4207,155,5263,3701,11621,605,1327,604,2107,3627,8299,8564,9387,8934,6563,10096,11408,7651,10200,10809,6555,2110,12121,3615,5594,2303,9175,5766,10885,4209,5145,7621,9143,156,11812,8337,2916,11777,8005,4196,11964,12206,7369,9630,9446,11595,4197,4307,5765,5310,11624,6112,3597,5595,10032,11045,8033,9186,8343,3716,10783,4656,11965,4219,5182,7404,11742,5849,5314,9029,11564,5155,6565,5311,4186,11909,2100,2790,5250,11527,4708,6127,1325,1686,5179,5143,9926,10803,3702,12111,9983,7132,2907,11490,12103,5872,5599,9921,5251,3617,3271,9629,8331,11110,11522,7240,4654,5265,6809,9929,6514,9927,11872,11543,2898,4711,4286,9898,4823,8007,7875,3672,11021,10843,11503,11520,12176,6113,3222,2707,8133,8923,1347,4646,6551,8976,8169,8924,2674,4001,1688,4824,3599,607,1683,2099,11205,3680,6516,8563,9015,11078,2948,3624,10866,2812,3462,10786,4195,2943,159,9445,5809,12141,3620,3464,10292,141,11873,6536,12014,5896,12118,4649,9385,11056,10881,3676,138,8028,9049,12394,7312,11758,11495,4288,8926,12136,4221,3616,4716,3621,3466,4820,2307,8975,2913,2111,148,9141,8019,11604,5819,12077,11855,11120,11513,11910,6566,6370,3677,8027,3625,2915,11187,4223,4822,5873,4707,9928,1336,8095,9112,2912,6568,4222,1679,8925,8977,6553,10802,10906,8099,10793,1685,10291,2784,7873,3221,10017,9941,5181,10091,10019,10976,7200,10878,3628,4183,2905,10757,12185,4181,5877,2945,22,11688,11610,2904,10873,3468,11820,11563,3105,5531,2106,8955,3618,10018,9050,8108,12076,3601,3821,5820,11856,9187,10841,3467,5533,4329,2944,8237,11415,4328,8102,9733,4284,10129,11574,3822,6101,5808,4719,11019,8953,3223,6098,11515,12083,4645,3998,11020,11407,11507,8943,3602,9059,9048,5159,4717,5875,4706,2909,4633,3999,11627,597,9056,2946,2309,10844,5177,598,5909,5935,6781,2960,9304,11600,147,3280,3279,10121,4655,8139,1334,6808,916,161,157,154,9028,1329,12142,9899,4715,3469,602,1689,7311,10756,2786,1687,3281,11741,7622,4629,1682,8020,6539,4220,8131,12208,11631,11606,10989,1326,7216,2788,4285,150,12092,4710,11524,7133,917,2906,11333,7403,2911,11619,9079,8956,8110,11046,8167,11714,4210,11616,6369,6128,4000,10092,3719,7983,12243,7238,11150,10758,4309,1331,8093,4305,10795,10785,144,8168,11620)
	then b.tt_baseline_10pct else 
	b.tt_baseline_25pct end AS baseline_tt,
case when segment_id in (12082,4287,11523,8623,10827,3272,11534,9575,8025,4200,9173,601,8340,12275,4718,3674,11861,2956,7492,8298,8062,4193,2306,4632,5316,5530,11109,10884,8111,606,11533,11686,5933,599,5876,10893,6552,5912,3714,151,6595,9174,8008,6535,2813,7201,5895,1680,6100,12128,2676,8109,2310,5894,8997,2672,11776,11565,10838,3270,2308,10024,12073,8140,6564,137,2702,8141,10882,4185,5816,5266,11531,4679,5817,2950,3715,8034,2109,4208,10826,9185,11638,136,3622,4192,5769,11867,4681,4201,6554,9075,11611,4650,2901,10822,9684,2899,5264,9172,11017,2699,5249,9952,8032,4628,4002,2900,4651,7239,4630,8009,8936,10383,3283,3600,3823,11525,11709,10784,149,12215,7241,3274,10097,5142,11204,8952,5804,10128,4198,5252,2785,3104,2704,2902,1335,2897,9014,6513,11514,3824,11540,135,10823,8236,4184,7214,11409,8971,2673,10119,5597,9113,4634,6593,8935,4659,7229,9844,8944,142,4306,9521,2304,160,9017,6130,5315,1333,11551,3465,9057,6782,7215,10530,4225,2949,6574,12262,914,7213,10001,4302,2698,10293,11591,3282,6575,6560,4658,3463,10120,4652,12100,11535,11578,9522,11508,4680,9386,11186,139,146,10905,8969,4227,12091,2705,143,6562,2108,8100,2816,3626,6102,10853,5308,5846,10817,11860,12074,4631,4709,10834,4304,11597,3470,3700,11584,7877,5527,8727,11630,10847,7772,2700,5844,2896,9883,145,8238,4199,5526,2955,8300,12112,11033,4194,2671,8995,4678,4224,4290,2910,4212,8922,9940,4226,11885,6576,10801,11811,11532,4310,9882,12133,3603,5146,6557,2703,7131,10836,8018,7292,595,10531,7491,6371,8342,10023,5313,11689,4657,6538,12247,12114,2787,5870,4308,1681,3598,140,5767,11491,9628,8933,11018,11055,10009,153,11593,10854,10000,6577,7242,8132,9951,12085,10010,10033,9884,6129,6149,7774,8301,2789,3269,2112,11625,2959,11713,9184,915,10393,12106,5532,1346,2953,3220,596,5156,10839,10877,10849,7228,7844,3224,7370,2701,3226,7731,6558,4301,10755,2101,3679,8570,5807,11034,3107,2815,2783,7291,10949,12090,2958,5596,10950,6784,4753,5309,6110,8454,10808,9683,4819,9081,3997,4330,11615,7202,6150,4182,8332,8006,152,4312,4720,6515,6114,3273,10663,3820,8624,5848,11603,12110,10988,8338,7876,12094,8968,8026,4647,5910,11562,11590,4311,2305,9058,4211,5768,7231,5934,96,10008,2814,2098,7650,8097,2104,11639,9918,7872,600,10874,2952,9142,12292,3106,5911,10821,2677,10842,10810,6596,6561,10381,11779,913,8974,11494,5180,5262,11755,8954,6099,8455,8004,10880,8061,5598,6556,6594,11149,6537,8970,8572,10116,3713,9734,6567,8339,8170,11521,10835,10892,1328,8101,9520,4635,603,3103,4653,11510,6111,7730,9982,3718,11592,8003,5600,7982,12015,6783,158,10879,2103,7773,8171,10833,3673,2914,12221,9060,5147,7178,9305,11332,1330,9920,12078,2102,3623,7489,2951,9447,3619,4648,5806,4213,2669,4636,11886,10794,5815,12072,6559,1332,11687,4821,7227,2706,8096,11614,3102,4303,6578,11526,9080,5254,11710,4289,10662,8098,7180,11504,2670,8562,11577,10907,5871,5818,2105,8573,4660,10837,3681,8978,9919,10865,8726,5805,5253,12093,5931,1684,2903,5932,7226,2908,3717,3225,10816,7874,4677,5144,3678,2954,11561,8341,5158,2675,10115,4643,2957,5157,11607,9845,12186,5178,10392,5528,3675,5845,8094,11416,5847,12129,7179,9016,4644,7230,7845,8996,2947,9074,5874,12294,7405,7490,5312,8021,3699,3284,10532,6368,11511,9939,4207,155,5263,3701,11621,605,1327,604,2107,3627,8299,8564,9387,8934,6563,10096,11408,7651,10200,10809,6555,2110,12121,3615,5594,2303,9175,5766,10885,4209,5145,7621,9143,156,11812,8337,2916,11777,8005,4196,11964,12206,7369,9630,9446,11595,4197,4307,5765,5310,11624,6112,3597,5595,10032,11045,8033,9186,8343,3716,10783,4656,11965,4219,5182,7404,11742,5849,5314,9029,11564,5155,6565,5311,4186,11909,2100,2790,5250,11527,4708,6127,1325,1686,5179,5143,9926,10803,3702,12111,9983,7132,2907,11490,12103,5872,5599,9921,5251,3617,3271,9629,8331,11110,11522,7240,4654,5265,6809,9929,6514,9927,11872,11543,2898,4711,4286,9898,4823,8007,7875,3672,11021,10843,11503,11520,12176,6113,3222,2707,8133,8923,1347,4646,6551,8976,8169,8924,2674,4001,1688,4824,3599,607,1683,2099,11205,3680,6516,8563,9015,11078,2948,3624,10866,2812,3462,10786,4195,2943,159,9445,5809,12141,3620,3464,10292,141,11873,6536,12014,5896,12118,4649,9385,11056,10881,3676,138,8028,9049,12394,7312,11758,11495,4288,8926,12136,4221,3616,4716,3621,3466,4820,2307,8975,2913,2111,148,9141,8019,11604,5819,12077,11855,11120,11513,11910,6566,6370,3677,8027,3625,2915,11187,4223,4822,5873,4707,9928,1336,8095,9112,2912,6568,4222,1679,8925,8977,6553,10802,10906,8099,10793,1685,10291,2784,7873,3221,10017,9941,5181,10091,10019,10976,7200,10878,3628,4183,2905,10757,12185,4181,5877,2945,22,11688,11610,2904,10873,3468,11820,11563,3105,5531,2106,8955,3618,10018,9050,8108,12076,3601,3821,5820,11856,9187,10841,3467,5533,4329,2944,8237,11415,4328,8102,9733,4284,10129,11574,3822,6101,5808,4719,11019,8953,3223,6098,11515,12083,4645,3998,11020,11407,11507,8943,3602,9059,9048,5159,4717,5875,4706,2909,4633,3999,11627,597,9056,2946,2309,10844,5177,598,5909,5935,6781,2960,9304,11600,147,3280,3279,10121,4655,8139,1334,6808,916,161,157,154,9028,1329,12142,9899,4715,3469,602,1689,7311,10756,2786,1687,3281,11741,7622,4629,1682,8020,6539,4220,8131,12208,11631,11606,10989,1326,7216,2788,4285,150,12092,4710,11524,7133,917,2906,11333,7403,2911,11619,9079,8956,8110,11046,8167,11714,4210,11616,6369,6128,4000,10092,3719,7983,12243,7238,11150,10758,4309,1331,8093,4305,10795,10785,144,8168,11620)
	then b.tt_baseline_10pct_corr else 	
	b.tt_baseline_25pct_corr end AS baseline_tt_corr,	
b.tt_baseline_25pct_med AS baseline_tt_med,
b.tt_baseline_25pct_med_corr AS baseline_tt_med_corr	
	
FROM congestion.tt_segments_30min_v4_2019_af a
LEFT JOIN congestion.tt_segments_baseline_v4_2019_af b
USING (segment_id)
WHERE a.segment_tt_avg_all IS NOT NULL
GROUP BY segment_id, datetime_bin::time, b.seg_length, b.tt_baseline_25pct, tt_baseline_10pct, tt_baseline_10pct_corr, tt_baseline_25pct_corr, tt_baseline_25pct_med, tt_baseline_25pct_med_corr
ORDER BY segment_id, datetime_bin::time
) abc